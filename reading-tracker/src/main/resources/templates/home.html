<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
	<link rel="stylesheet" href="/css/home.css">
	<script src="/js/authenticate.js"></script> 
</head>
<body>
	<div class="wrapper">
		<nav>
			<ul class="nav-links">
				<li><a href="/api/home/add">Add Book</a></li>
				<li><a href="/api/home/genres">Browse by Genre</a></li>
				<li><a href="/logout">Logout</a></li>
			</ul>  
		</nav>
	</div>
	<div id="search-section">
	    <input type="text" id="search-input" placeholder="Search by name, author or genre">
	    <select id="rating-filter">
	        <option value="">Any Rating</option>
	        <option value="1">1‚≠ê</option>
	        <option value="2">2‚≠ê</option>
	        <option value="3">3‚≠ê</option>
	        <option value="4">4‚≠ê</option>
	        <option value="5">5‚≠ê</option>
	    </select>
	    <select id="status-filter">
	        <option value="">Any Status</option>
			<option value="TO_READ">To Read</option>
			<option value="READING">Reading</option>
			<option value="READ">Read</option>
	    </select>
	    <button onclick="searchBooks()">üîç Search</button>
	</div>
	<div class="container" id="response">
		<h1>Welcome to Your Book Tracker</h1>
		<br>
	    <h2>Recently Added Books</h2>
	    <div id="book-list"></div>
    </div>
	<script>
		async function searchBooks() {
		    const token = localStorage.getItem("token");
		    const query = document.getElementById("search-input").value.trim();
		    const rating = document.getElementById("rating-filter").value;
		    const status = document.getElementById("status-filter").value;

		    let url = `/api/home/search?query=${encodeURIComponent(query)}`;
		    if (rating) url += `&rating=${rating}`;
		    if (status) url += `&status=${status}`;

		    try {
		        const res = await fetch(url, {
		            headers: { "Authorization": `Bearer ${token}` }
		        });

		        if (!res.ok) throw new Error("Search failed");
		        const books = await res.json();

		        const list = document.getElementById("book-list");
		        if (books.length === 0) {
		            list.innerHTML = "<p>No books found.</p>";
		            return;
		        }

				


		        list.innerHTML = books.map(book => `
		            <div class="book-card">
		                <img src="${book.image}" alt="${book.name}">
		                <div class="book-info">
		                    <h3>${book.name}</h3>
		                    <p><strong>Author:</strong> ${book.author}</p>
		                    <p><strong>Genre:</strong> ${book.genre}</p>
		                    <p style="text-transform: capitalize;"><strong>Status:</strong> ${book.status}</p>
		                    <p><strong>Rating:</strong> ${"‚òÖ".repeat(book.rating) + "‚òÜ".repeat(5 - book.rating)}</p>
		                    <div class="book-actions">
		                        <a href="/api/home/view?id=${book.id}">üëÅÔ∏è View</a>
		                        <a href="/api/home/update?id=${book.id}">‚úèÔ∏è Update</a>
		                        <button onclick="deleteBook(${book.id})">üóëÔ∏è Delete</button>
		                    </div>
		                </div>
		            </div>
		        `).join("");
		    } catch (error) {
		        console.error(error);
		        alert("Error searching books.");
		    }
		}

		        async function loadBooks() {
		            const token = localStorage.getItem("token");
		            if (!token) {
		                alert("Please login first.");
		                window.location.href = "/api/login";
		                return;
		            }

		            try {
		                const response = await fetch("/api/home/books", {
		                    headers: { "Authorization": `Bearer ${token}` }
		                });

						if (!response.ok) {
						    const errorText = await response.text();
						    console.error("Server error response:", errorText);
						    throw new Error("Failed to fetch books");
						}

						const contentType = response.headers.get("content-type");
						if (!contentType || !contentType.includes("application/json")) {
						    const errorText = await response.text();
						    throw new Error(`Expected JSON but got: ${errorText}`);
						}


		                const books = await response.json();
		                const recentBooks = books.slice(-10).reverse(); // last 10, newest first

		                const list = document.getElementById("book-list");
		                list.innerHTML = recentBooks.map(book => `
		                    <div class="book-card">
		                        <img src="${book.image}" alt="${book.name}">
		                        <div class="book-info">
		                            <h3>${book.name}</h3>
		                            <p><strong>Author:</strong> ${book.author}</p>
		                            <p style="text-transform: capitalize;"><strong>Status:</strong> ${book.status}</p>
		                            <div class="book-actions">
		                                <a href="/api/home/view?id=${book.id}">üëÅÔ∏è View</a>
		                                <a href="/api/home/update?id=${book.id}">‚úèÔ∏è Update</a>
		                                <button onclick="deleteBook(${book.id})">üóëÔ∏è Delete</button>
		                            </div>
		                        </div>
		                    </div>
		                `).join("");
		            } catch (error) {
		                document.getElementById("book-list").innerText = "Failed to load books.";
		                console.error("Error loading books:", error);
		            }
		        }

		        async function deleteBook(id) {
		            const token = localStorage.getItem("token");
		            const confirmDelete = confirm("Are you sure you want to delete this book?");
		            if (!confirmDelete) return;

		            try {
		                await fetch(`/api/home?id=${id}`, {
		                    method: "DELETE",
		                    headers: { "Authorization": `Bearer ${token}` }
		                });
		                loadBooks();
		            } catch (error) {
		                alert("Failed to delete book.");
		                console.error("Delete error:", error);
		            }
		        }

		        loadBooks();
		    </script>
</body>
</html>